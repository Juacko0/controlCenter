<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Centro de Control - Cámaras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

<!-- 🔒 LOGIN DIFUMINADO -->
<div id="loginOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-lg">
  <!-- Fondo difuminado -->
  <div class="absolute inset-0 bg-[url('assets/fondo-control.jpg')] bg-cover bg-center blur-sm"></div>

  <!-- Capa semitransparente -->
  <div class="absolute inset-0 bg-black/40 backdrop-blur-md"></div>

  <!-- Cuadro de login -->
  <div class="relative z-10 flex items-center justify-center">
    <div class="bg-white/10 backdrop-blur-lg p-8 rounded-2xl shadow-2xl w-96 text-center border border-white/20">
      <h2 class="text-2xl font-semibold text-white mb-6">🔐 Inicia Sesión</h2>
      <form id="loginForm" class="space-y-4">
        <input type="text" id="usuario" placeholder="Código (ej. P001)" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:outline-none">
        <input type="password" id="password" placeholder="PIN de acceso" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:outline-none">
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition">Entrar</button>
      </form>
    </div>
  </div>
</div>

  <!-- Barra superior -->
<header class="flex justify-between items-center px-6 py-3 bg-gray-800 shadow-md">
  <!-- Título -->
  <h1 class="text-2xl font-bold">Centro de Control</h1>
  <span id="usuarioActivoLabel" class="text-gray-300 ml-2 text-sm"></span>
  <header class="flex justify-end p-4 bg-gray-800 text-white">
  <span id="usuarioActivoLabel" class="mr-4"></span>
  <button id="logoutButton" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">
    Cerrar sesión
  </button>
  </header>

  <!-- Navegación + Configuración -->
  <div class="flex items-center space-x-2">
    <button id="btnProfesionales"
      class="px-3 py-2 rounded-lg font-medium bg-gray-700/60 backdrop-blur-sm hover:bg-gray-600/70 hover:shadow-md hover:shadow-gray-500/20 transition-all duration-200">
      Gestión de Profesionales
    </button>

    <button id="btnResidentes"
      class="px-3 py-2 rounded-lg font-medium bg-gray-700/60 backdrop-blur-sm hover:bg-gray-600/70 hover:shadow-md hover:shadow-gray-500/20 transition-all duration-200">
      Gestión de Residentes
    </button>

    <button id="configBtn"
      class="ml-3 p-2 rounded-full hover:bg-gray-700 text-2xl transition-all duration-200">
      ⚙️
    </button>
  </div>
<!-- 🪟 Modal de Datos -->
<div id="dataModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 transition">
  <div class="bg-gray-900 text-white rounded-2xl shadow-2xl w-11/12 md:w-3/4 lg:w-1/2 p-6 relative border border-gray-700">
    
    <!-- Botón cerrar -->
    <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl font-bold">
      &times;
    </button>

    <!-- Título -->
    <h2 id="modalTitle" class="text-2xl font-semibold mb-4 text-blue-400 border-b border-gray-700 pb-2">
      Datos
    </h2>

    <!-- Contenido -->
    <div id="modalContent" class="overflow-x-auto max-h-[70vh]">
      <!-- Aquí se insertará dinámicamente la tabla -->
      <p class="text-gray-400 text-center">Cargando información...</p>
    </div>
  </div>
</div>
</header>
<!-- Contenido principal -->
<main class="flex flex-1 overflow-hidden flex-col">

  <!-- 🔹 Vista principal: Cámaras + Historial -->
  <div id="mainSection" class="flex flex-1 overflow-hidden">
    <!-- Cámaras -->
    <section class="flex-1 grid grid-cols-2 gap-2 p-2 overflow-y-auto">
      <canvas id="cam1" class="camera bg-black rounded-lg" data-location="Cámara Laptop"></canvas>
      <div class="camera bg-gray-700 flex items-center justify-center rounded-lg" data-location="Pasillo Norte">Cámara 2</div>
      <div class="camera bg-gray-700 flex items-center justify-center rounded-lg" data-location="Comedor">Cámara 3</div>
      <div class="camera bg-gray-700 flex items-center justify-center rounded-lg" data-location="Habitación 12">Cámara 4</div>
    </section>

    <!-- Historial lateral -->
    <aside class="w-80 bg-gray-800 p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2">Historial Rápido</h2>
      <div id="incidentHistory" class="space-y-2 overflow-y-auto flex-1">
        <p class="text-gray-400">Sin incidentes registrados</p>
      </div>
      <button id="verHistorialBtn" class="mt-4 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
        Ver historial completo
      </button>
    </aside>
  </div>

  <!-- 🔹 Modal: Gestión de Profesionales -->
  <div id="profesionalesModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50">
    <div class="bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-4xl p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Gestión de Profesionales</h2>
        <button id="closeProfesionales" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <p class="text-gray-400 mb-3">Administra el personal médico y de enfermería.</p>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-800 border border-gray-700 rounded-lg">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-2 text-left">ID</th>
              <th class="px-4 py-2 text-left">Nombre</th>
              <th class="px-4 py-2 text-left">Horario</th>
              <th class="px-4 py-2 text-left">Código PWA</th>
              <th class="px-4 py-2 text-left">Estado</th>
              <th class="px-4 py-2 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaProfesionales"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 🔹 Modal: Gestión de Residentes -->
  <div id="residentesModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50">
    <div class="bg-gray-800 rounded-lg shadow-lg w-11/12 max-w-3xl p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Gestión de Residentes</h2>
        <button id="closeResidentes" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <p class="text-gray-400 mb-3">Administra los residentes del centro.</p>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-800 border border-gray-700 rounded-lg">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-2 text-left">ID</th>
              <th class="px-4 py-2 text-left">Nombre Completo</th>
              <th class="px-4 py-2 text-left">Apoyo para Caminar</th>
              <th class="px-4 py-2 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaResidentes"></tbody>
        </table>
      </div>
    </div>
  </div>

</main>

  <!-- Modal de alerta -->
  <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white text-black p-6 rounded-lg w-96">
      <h3 class="text-xl font-bold text-red-600 mb-4">🚨 ¡Incidente Detectado!</h3>

      <p><strong>📍 Ubicación:</strong> <span id="incidentLocation"></span></p>
      <p><strong>⏱️ Hora:</strong> <span id="incidentTime"></span></p>

      <label class="block mt-3">👤 Nombre del residente:
        <input type="text" id="incidentResident" placeholder="Ej. Ana Torres" class="border p-2 rounded w-full" />
      </label>

      <label class="block mt-3">🩹 Nivel de lesión:
        <select id="incidentInjuryLevel" class="border p-2 rounded w-full">
          <option value="1">1 - Leve</option>
          <option value="2">2 - Moderada</option>
          <option value="3">3 - Grave</option>
        </select>
      </label>

      <label class="block mt-3">💥 Tipo de incidente:
        <select id="incidentType" class="border p-2 rounded w-full">
          <option value="false">Otro (no caída)</option>
          <option value="true">Caída</option>
        </select>
      </label>

      <label class="block mt-3">📝 Detalle:
        <textarea id="incidentDetail" placeholder="Ej. Resbalón en el comedor, sin lesiones aparentes" class="border p-2 rounded w-full"></textarea>
      </label>

      <div class="flex justify-end mt-4 space-x-2">
        <button id="saveIncident" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">💾 Guardar</button>
        <button id="markAttended" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">✅ Marcar atendido</button>
        <button id="closeIncidentModal" class="bg-gray-400 px-4 py-2 rounded hover:bg-gray-500">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de historial completo -->
  <div id="historialModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white text-black p-6 rounded-lg w-3/4 h-3/4 flex flex-col">
      <h3 class="text-xl font-bold mb-4">Historial Completo</h3>

      <!-- Filtros -->
      <div class="flex space-x-4 mb-4">
        <input type="date" id="filterDate" class="border p-2 rounded" />
        <select id="filterState" class="border p-2 rounded">
          <option value="">Estado</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Atendido">Atendido</option>
        </select>
        <input type="text" id="filterLocation" placeholder="Ubicación" class="border p-2 rounded flex-1" />
        <button id="applyFilters" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Filtrar</button>
      </div>

      <!-- Tabla -->
      <div class="overflow-y-auto flex-1">
        <table class="w-full border">
          <thead>
            <tr class="bg-gray-200">
              <th class="border px-2 py-1">Fecha/Hora</th>
              <th class="border px-2 py-1">Ubicación</th>
              <th class="border px-2 py-1">Detalle</th>
              <th class="border px-2 py-1">Estado</th>
            </tr>
          </thead>
          <tbody id="historialTable"></tbody>
        </table>
      </div>

      <!-- Botones -->
      <div class="flex justify-between mt-4">
        <div class="space-x-2">
          <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">📄 Exportar CSV</button>
          <button id="exportPDF" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">📑 Exportar PDF</button>
        </div>
        <button id="closeHistorial" class="bg-gray-400 px-4 py-2 rounded hover:bg-gray-500">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de configuración -->
  <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white text-black p-6 rounded-lg w-96">
      <h3 class="text-xl font-bold mb-4">Configuración</h3>
      <label class="block mb-2">🔊 Volumen de alerta
        <input type="range" min="0" max="1" step="0.1" id="volumeControl" class="w-full" />
      </label>
      <label class="block mb-2">⏱️ Tiempo de simulación (segundos)
        <input type="number" id="simTime" value="3" class="border p-1 w-full rounded" />
      </label>
      <div class="flex justify-between mt-4">
        <button id="toggleSimBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">▶️ Iniciar simulación</button>
        <button id="closeConfig" class="bg-gray-400 px-4 py-2 rounded hover:bg-gray-500">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de edición -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-60 justify-center items-center">
    <div class="bg-gray-800 p-6 rounded-2xl w-96">
      <h2 class="text-xl mb-3 text-center font-semibold">✏️ Editar Incidente</h2>
      <label class="block mb-1 text-sm">Ubicación:</label>
      <input id="editLocation" class="w-full mb-2 p-1 rounded bg-gray-700 border border-gray-600" />

      <label class="block mb-1 text-sm">Detalle:</label>
      <textarea id="editDetail" class="w-full mb-2 p-1 rounded bg-gray-700 border border-gray-600"></textarea>

      <label class="block mb-1 text-sm">Estado:</label>
      <select id="editState" class="w-full mb-4 p-1 rounded bg-gray-700 border border-gray-600">
        <option>Pendiente</option>
        <option>Atendido</option>
        <option>En revisión</option>
      </select>

      <div class="flex justify-between">
        <button id="saveEdit" class="bg-green-500 px-3 py-1 rounded hover:bg-green-600">Guardar</button>
        <button id="cancelEdit" class="bg-gray-500 px-3 py-1 rounded hover:bg-gray-600">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="alertSound" src="assets/alert.mp3"></audio>

  <script src="/rtsp-relay.js"></script>
  <script src="js/main.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("✅ Service Worker registrado"))
        .catch(err => console.error("❌ Error registrando SW:", err));
    }
  </script>
</body>
</html>
